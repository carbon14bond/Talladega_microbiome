---
title: "Talladega_synoptic_map"
author: "Charles T. Bond"
date: "`r Sys.Date()`"
output: html_document
---
# Talladega Map, Charles Bond et al. microbiome Tal Synoptic manuscript
#### generating map of sites labeled with metadata

## Shapefiles for maps are available on Hydroshare:
#### Peterson, D., N. Jones (2025). AIMS_SE_TAL_ENVI, HydroShare, http://www.hydroshare.org/resource/81c003a7b8474d63a31641a4f375fd18

```{r}
# setup
rm(list = ls())
setwd("/Users/chunk/Talladega_synoptic/meta_prep/map")
knitr::opts_knit$set(root.dir = "/Users/chunk/Talladega_synoptic/meta_prep/map")
library(tidyverse)
library(RColorBrewer)
# library(rgdal) # might be necessary to use earlier version of R
library(sf)

theme_set(theme_bw() + theme(
  plot.title = element_text(size=20, color="black"),
  axis.text.x = element_text(size=15, color="black"),
  axis.text.y = element_text(size=15, color="black"),
  axis.title.x = element_text(size=15),
  axis.title.y = element_text(size=15),
  legend.text = element_text(size=12),
  legend.title = element_text(size=15),
  #  legend.position = "bottom",
  #  legend.key=element_blank(),
  #  legend.key.size = unit(0.5, "cm"),
  #  legend.spacing.x = unit(0.1, "cm"),
  #  legend.spacing.y = unit(0.1, "cm"),
  panel.background = element_blank(), 
  #panel.border = element_rect(colour = "black", fill=NA, size=1),
  plot.background = element_blank()))

```

```{r}
setwd("/Users/chunk/Talladega_synoptic/meta_prep/map")
talmap<- st_read("streamnetwork_TAL.shp")

talmap_ll <- st_transform(talmap, "+proj=longlat +ellps=WGS84 +datum=WGS84")

talws<- st_read("watershed_TAL.shp")
talws_ll <- st_transform(talws, "+proj=longlat +ellps=WGS84 +datum=WGS84")

#head(st_coordinates(kzmap_ll))
# Check the extent of the transformed data
print(st_bbox(talmap_ll))

# Check the CRS of the transformed data
print(st_crs(talmap_ll))

strmp1 <- ggplot() +
  geom_sf(data = talws_ll) +
  geom_sf(data = talmap_ll) +
  coord_sf(ylim=c(33.7590, 33.7685), xlim = c(-85.607, -85.595))
strmp1

meta_tab<- read.csv("meta_test_05.12.2025.csv", row.names=1)
meta_tab <- meta_tab[meta_tab$siteId!="TLMBP",]

```

```{r}
library(viridis)
TALmap <- ggplot() +
  geom_sf(data = talws_ll) +
  geom_sf(data = talmap_ll) +
  coord_sf(ylim=c(33.7576, 33.7715), xlim = c(-85.60915, -85.5952))+
  # coord_sf(ylim=c(39.071, 39.093), xlim = c(-96.595, -96.565))+
  geom_point(data=meta_tab, aes(x=long, y=lat, fill=percentwet_11month, shape=WetDry), size=3.3)+
   scale_fill_viridis(option="viridis", discrete = FALSE, begin = 1, end = 0.2, labels = scales::percent_format())+
#  scale_colour_gradientn(colors = rev(pal), labels = scales::percent_format(), limits = common_limits)+
  scale_shape_manual(values = c(23,21))+
  labs(legend="right", shape="Wet/Dry:", fill="11-month water persistence:", x="Longitude", y="Latitude"
  )+ 
 theme(axis.text.x = element_text(size = 8, angle=30, vjust=1, hjust=1), axis.text.y = element_text(size = 8), legend.title=element_text(size=10), 
        legend.text=element_text(size=10))
TALmap

library(ragg)
plotout <- "TAL_map_08282025.tiff"
agg_tiff(filename=plotout, width=2500, height=2000, units="px",
         pointsize=10, res=600, compression="lzw", scaling=0.5)
TALmap
invisible(dev.off())
```


### environmental data correlation plots 
Some sites are missing data; e.g., not all sites had surface water, so dissolved gases couldn't be sampled. We therefore make different correlation plots ddepending on available data, e.g., one including variables with complete data for all 47 sites, one for all sites with STIC data (n=40), and one for all sites with gas data + STIC data (n=31). 

A. All sites (excluding beaver pond)
```{r}
meta_tab_sites<-meta_tab
metasite_corr<- meta_tab_sites[,c("S_AFDM_prc","LL_AFDM_prc","elevation","distance_from_outlet","drainage_area_ha","twi", "slope_point","slope_buffer","stream_slope","Canopy_Cover_pct","Quercus_spp","Fagus_grandifolia","Liriodendron_tulipifera","Acer_spp")]

library(linkET)
metacorrplot_47<- qcorrplot(correlate(x=metasite_corr[1:14], y=NULL, method = "spearman",adjust = TRUE,
  adjust_method = "holm"),
  type = "lower", diag = FALSE, grid_size = 0.6)+
  geom_square() +
  geom_mark(sep = '\n',size=4,sig_level = c(0.05,0.01,0.001),sig_thres = 0.05,
            only_mark = TRUE)+
  #scale_fill_gradientn(colours = RColorBrewer::brewer.pal(11, "RdBu"))+
  scale_fill_gradientn(colours = RColorBrewer::brewer.pal(11, "RdYlBu"))+
  guides(fill = guide_colorbar(title = "Spearman's rho"))+
  theme(legend.key.size = unit(9,"pt"),
        axis.text = element_text(size = 9,color = "black",angle=30,vjust=1, hjust=1),
        strip.text = element_text(size = 9,color = "black"),
        plot.title=element_text(size=12),
        axis.title.x.bottom = element_text(angle=30),
        axis.text.x = element_text(size = 9), axis.text.y = element_text(size = 8),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 7))+
  theme(legend.position = "right")+
  xlab(label="")+
  ylab(label="")+
  labs(title = "All stream sites (n=47)")
metacorrplot_47


```

B.
```{r}
## Sites with 11 month percent wet
metadata_sitecharsa<-meta_tab_sites[!is.na(meta_tab_sites$percentwet_11month),]
metasite_corr<- metadata_sitecharsa[,c("percentwet_11month", "S_AFDM_prc","LL_AFDM_prc","drainage_area_ha","stream_slope","Canopy_Cover_pct","Quercus_spp","Fagus_grandifolia","Liriodendron_tulipifera","Acer_spp")]

metacorrplot11<- qcorrplot(correlate(x=metasite_corr[1:10], y=NULL, method = "spearman", adjust = FALSE,
  adjust_method = "holm"), type = "lower", diag = FALSE, grid_size = 0.6, tl.srt = 45) +
  geom_square() +
  geom_mark(sep = '\n',size=4,sig_level = c(0.05,0.01,0.001),sig_thres = 0.05,
            only_mark = TRUE)+
  #scale_fill_gradientn(colours = RColorBrewer::brewer.pal(11, "RdBu"))+
  scale_fill_gradientn(colours = RColorBrewer::brewer.pal(11, "RdYlBu"))+
  guides(fill = guide_colorbar(title = "Spearman's rho"))+
  theme(legend.key.size = unit(8,"pt"),
        axis.text = element_text(size = 8, color = "black",angle=36,vjust=1, hjust=1.05),
        strip.text = element_text(size = 8, color = "black"),
        axis.text.x.bottom = element_text(size = 8, angle=36,vjust=1.05, hjust=1),
        #axis.text.x.top = element_text(angle=30,vjust=1, hjust=1),
        plot.title=element_text(size=12),
        axis.text.x = element_text(size = 8),axis.text.y = element_text(size = 8),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 7))+
  theme(legend.position = "right")+
  xlab(label="")+
  ylab(label="")+
  labs(title = "STIC sites (n=40)")
metacorrplot11
### for supplemental information, export plots

```

```{}
## Sites with complete dissolved gas data 
metadata_sitecharsa<-meta_tab_sites[!is.na(meta_tab_sites$CO2_avg),]
metasite_corr<- metadata_sitecharsa[,c("S_AFDM_prc","LL_AFDM_prc","elevation","distance_from_outlet","drainage_area_ha","twi", "stream_slope","Canopy_Cover_pct", "W_Chla", "O2_uM_avg","N2Ar_avg","CO2_avg","N2O_avg", "CH4_avg")]

metacorrplotgas<- qcorrplot(correlate(x=metasite_corr[1:14], y=NULL, method = "spearman", adjust = TRUE,
  adjust_method = "holm"), type = "lower", diag = FALSE, grid_size = 0.6) +
  geom_square() +
  geom_mark(sep = '\n',size=4,sig_level = c(0.05,0.01,0.001),sig_thres = 0.05,
            only_mark = TRUE)+
  #scale_fill_gradientn(colours = RColorBrewer::brewer.pal(11, "RdBu"))+
  scale_fill_gradientn(colours = RColorBrewer::brewer.pal(11, "RdYlBu"))+
  guides(fill = guide_colorbar(title = "Spearman's rho"))+
  theme(legend.key.size = unit(9,"pt"),
        axis.text = element_text(size = 9,color = "black"),
        strip.text = element_text(size = 9,color = "black"),
        plot.title=element_text(size=12),
        axis.text.x = element_text(size = 9),axis.text.y = element_text(size = 8),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 7))+
  theme(legend.position = "right")+
  xlab(label="")+
  ylab(label="")+
  labs(title = "Dissolved gas sites (n=38)")
metacorrplotgas

```

```{r}
## Sites with complete dissolved gas data 
metadata_sitecharsa<-meta_tab_sites[!is.na(meta_tab_sites$CO2_avg),]
metadata_sitecharsa<-metadata_sitecharsa[!is.na(metadata_sitecharsa$percentwet_11month),]
metasite_corr<- metadata_sitecharsa[,c("percentwet_11month", "O2_uM_avg","N2Ar_avg","CO2_avg","N2O_avg", "CH4_avg")]

metacorrplotgas11<- qcorrplot(correlate(x=metasite_corr[1:6], y=NULL, method = "spearman", adjust = FALSE,
  adjust_method = "holm"), type = "lower", diag = FALSE, grid_size = 0.6) +
  geom_square() +
  geom_mark(sep = '\n',size=6,sig_level = c(0.05,0.01,0.001),sig_thres = 0.05,
            only_mark = TRUE)+
  #scale_fill_gradientn(colours = RColorBrewer::brewer.pal(11, "RdBu"))+
  scale_fill_gradientn(colours = RColorBrewer::brewer.pal(11, "RdYlBu"))+
  guides(fill = guide_colorbar(title = "Spearman's rho"))+
  theme(legend.key.size = unit(8,"pt"),
        axis.text = element_text(size = 8, color = "black",angle=36,vjust=1, hjust=1.05),
        strip.text = element_text(size = 8, color = "black"),
        axis.text.x.bottom = element_text(size = 8, angle=36,vjust=1.05, hjust=1),
        #axis.text.x.top = element_text(angle=30,vjust=1, hjust=1),
        plot.title=element_text(size=12),
        axis.text.x = element_text(size = 8),axis.text.y = element_text(size = 8),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 7))+
  theme(legend.position = "right")+
  xlab(label="")+
  ylab(label="")+
  labs(title = "STIC + Gas sites (n=31)")
metacorrplotgas11

```

```{r}
library(cowplot)

bc<-plot_grid(metacorrplot11, metacorrplotgas11, labels=c('B','C'), rel_widths = c(1.1,1), ncol=2, scale = 1.05)


plotout <- "TAL_map_corrplots_08.28.2025.tiff"
agg_tiff(filename=plotout, width=4600, height=5000, units="px",
         pointsize=10, res=600, compression="lzw", scaling=1)
plot_grid(TALmap, bc, labels=c('A',''), ncol=1, rel_heights =c(1,0.7))
invisible(dev.off())
plot_grid(TALmap, bc, labels=c('A',''), ncol=1, rel_heights =c(1,0.7))
```

```{r}
## detatch linkET package, it interferes with downstream stats
detach("package:linkET", unload=TRUE)
```


---
title: "Analysis_0.4_Gen.spp.GLLVMs"
author: "Charles T. Bond"
date: "`r Sys.Date()`"
output: html_document
---

# Microbial Community Analysis: Talladega Forest Non-perennial Stream Network

## Analysis_0.4: Microbial taxa across the stream network

### Introduction
Following the analysis and visualization of major phyla and class of microbess in Analysis 0.3, we will now look into the taxonomic groups of prokaryotes and fungi occuring in the stream. See the next analysis (0.5) for generalized linear latent variable models for top genera, species, or PICRUSt2-based functional trait assignment.

## Setup
```{r, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)
setwd("/Users/chunk/Talladega_synoptic/Analysis")
knitr::opts_knit$set(root.dir = "/Users/chunk/Talladega_synoptic/Analysis")
options(knitr.duplicate.label = "allow") ### so I don't have to give chunks unique names
```

```{r}
#library(dada2)
library(phyloseq)
library(vegan)
library(ggplot2)
library(tidyr)
library(dplyr)
library(pheatmap)
library(GUniFrac)
library(pals)
library(RColorBrewer)
library(ragg)
library(ggpubr)

#Set theme
theme_set(theme_bw() + theme(
             # plot.title = element_text(size=15, color="black"),
              axis.title.x = element_text(size=11),
             # axis.title.y = element_text(size=15),
              legend.text = element_text(size=12),
              legend.title = element_text(size=15),
            #  legend.position = "bottom",
            #  legend.key=element_blank(),
            #  legend.key.size = unit(0.5, "cm"),
            #  legend.spacing.x = unit(0.1, "cm"),
            #  legend.spacing.y = unit(0.1, "cm"),
              panel.background = element_blank(), 
              #panel.border = element_rect(colour = "black", fill=NA, size=1),
              plot.background = element_blank()))
```

## Load phyloseq objects
```{r}
#prokaryotes
load("/Users/chunk/Talladega_synoptic/Analysis/Rdata/pseqtest16S.rdata")
pseqtest16S

#fungi
load("/Users/chunk/Talladega_synoptic/Analysis/Rdata/pseqtestITS.rdata")
pseqtestITS

## Cutting the single beaver pond site, its an outlier, the only permanent lentic site
pseqtest16S <- subset_samples(pseqtest16S, siteId != "TLMBP")
pseqtestITS <- subset_samples(pseqtestITS, siteId != "TLMBP")

# extract sampe data
samdf_16S <- data.frame(sample_data(pseqtest16S))
samdf_ITS <- data.frame(sample_data(pseqtestITS))
```



# Top prokaryotic ASVs/spp

In the past I've lumped taxa to the gens level for corrplots, but I see some aquatic hyphomycete genus standing out that I'd like to keep at the genus level. So, I will make a new object combining
```{r}
pseqtest16S_gen <- pseqtest16S
### If Species == NA, rename 'gen.'. We will merge these, so potentially multiple genus may be merged together.
#na.sp = !is.na(tax_table(pseqtest16S_gen)[,"Genus"]) & is.na(tax_table(pseqtest16S_gen)[,"Species"])
#tax_table(pseqtest16S_gen)[na.sp][,"Species"] <- "sp. unk."
#na.gn  = is.na(tax_table(pseqtest16S_gen)[,"Genus"])#
#tax_table(pseqtest16S_gen)[na.gn][,"Species"] <- ""
### good

### Now, make "Species" "Genus genus"
## Genus and Species is not NA
#no.na <- !is.na(tax_table(pseqtest16S_gen)[,"Genus"]) & !is.na(tax_table(pseqtest16S_gen)[,"Species"])
## Replace Species with full name
#tax_table(pseqtest16S_gen)[no.na][,"Species"] <- paste(tax_table(pseqtest16S_gen)[no.na][,"Genus"], tax_table(pseqtest16S_gen)[no.na][,"Species"])

## We could also include unidentified families or higher levels
### family
#lo.fam<- !is.na(tax_table(pseqtest16S_gen)[,"Family"]) & is.na(tax_table(pseqtest16S_gen)[,"Genus"])
#tax_table(pseqtest16S_gen)[lo.fam][,"Species"] <- paste("unidentified", tax_table(pseqtest16S_gen)[lo.fam][,"Family"])

```

Now we will agglomerate ('lump') taxa to the lowest rank possible.
```{r}
### genus agglomeration
## make taxonomy object by genus
gen_counts_tab <- otu_table(tax_glom(pseqtest16S_gen, taxrank = "Genus"), taxa_are_rows = FALSE)
gen_counts_tab <- t(gen_counts_tab)
## make vector of genus names to set as row names
gen_tax_vec <- as.vector(tax_table(tax_glom(pseqtest16S_gen, taxrank="Genus"))[,6]) 
rownames(gen_counts_tab) <- as.vector(gen_tax_vec)

asv_counts <- pseqtest16S_gen@otu_table
#determine the number of unclassified seqs at the genus level
unclassified_gen_counts <- colSums(t(asv_counts)) - colSums(gen_counts_tab)
#Add a row of "unclassified" to the genus count table
genus_and_unidentified_counts_tab <- rbind(gen_counts_tab, "Unclassified_genus"=unclassified_gen_counts)

## test all counts are accounted for
identical(colSums(genus_and_unidentified_counts_tab), rowSums(asv_counts))

## convert counts to percent abundance:
genus_proportions <- apply(genus_and_unidentified_counts_tab, 2, function(x) x/sum(x)*100)

#Merge with metadata
genus_merge <- merge(t(genus_proportions), samdf_16S,
                  by="row.names", all=TRUE)
rownames(genus_merge) <- genus_merge[,1]
genus_merge <- genus_merge[,-1]
gn<- as.numeric(nrow(genus_proportions))
```

#### Leaf Litter Species at sites with stic data
```{r}
library(stringr)
genmerge_L<- genus_merge[genus_merge$substrate=='L',]
genmerge_L<- genmerge_L[!is.na(genmerge_L$percentwet_11month),]
gentemp_L<- genmerge_L[,1:gn]

#Reorder data table from most abundant to least abundant
gentemp_L <- gentemp_L[,order(colSums(-gentemp_L,na.rm=TRUE))]
gentemp_L <- gentemp_L[,apply(gentemp_L,2,function(x) sum(x > 0))>1]

sapply(gentemp_L, sd)

genmerge_L <- merge(gentemp_L, samdf_16S,
                  by="row.names", all=FALSE)
rownames(genmerge_L) <- genmerge_L[,1]
genmerge_L <- genmerge_L[,-1]
genmerge_L<- genmerge_L[,colnames(genmerge_L)!="Unclassified_genus"]



library(mvabund)
library(gllvm)
library(tidyverse)

#detach("package:linkET", unload=TRUE)
L_abun<-genmerge_L[,1:40]
X <- as.matrix(genmerge_L[,c("percentwet_11month","LL_AFDM_prc")])
y<-as.matrix(as.tibble(L_abun))

gllvm(y, family = "poisson")
gllvm(y, family = "negative.binomial")
fit_ord<- gllvm(y, family = "negative.binomial")
ordiplot(fit_ord, biplot=TRUE, ind.gen=14)

#gllvm(y, X, family = "negative.binomial")
#gllvm(y, family = "negative.binomial")
#gllvm(formula = y~X$prc_wet, family = "negative.binomial")

fit_env <- gllvm(y, X, family = "negative.binomial", num.lv = 1,
                 formula = ~ percentwet_11month, seed = 2025)
coefplot(fit_env, cex.ylab = 0.7, mar = c(4, 9, 2, 1), mfrow=c(1,1))

pdf("GLLVM_16S_LL_plot.pdf", 
    )
gllvm16S_L<- coefplot(fit_env, cex.ylab = 0.7, mar = c(4, 15, 2, 1), mfrow=c(1,1))
gllvm16S_L
dev.off()
```
```{r}

coefP<- as.data.frame(fit_env$params$Xcoef) ## extract coefficients from gllvm
confP<- as.data.frame(confint(fit_env, parm = "Xcoef")) ##extract confidence intervals of coefficients from gllvm
row.names(confP)<- row.names(coefP) ## keeping consistent row names and order between coefficient and confidence interval objects
coefP<- merge(coefP, confP[,1:2], by="row.names", all = TRUE) ## merging coefficient and confidence interval objects
row.names(coefP)<- coefP[,1] ## converts the actual row names of the new merged object to the unfortunate "Row.names" column created after merging
coefP<- coefP[,-1] ## remove the unfortunate "Row.names" column from the object
coefP<- coefP %>% 
  mutate(taxID = row.names(coefP))   ## create a column with the species ID from the row names
coefP<- coefP %>%             ## create a color key for the confidence intervals
  mutate(error_bar_color = case_when(
    cilow > 0 ~ "Positive",
    ciup < 0 ~ "Negative",
    TRUE ~ "Neutral"
  ))

### checking for outliers
coefP$ciup-coefP$cilow
mean(coefP$percentwet_11month)
sd(coefP$percentwet_11month)
mean(coefP$ciup-coefP$cilow)
sd(coefP$ciup-coefP$cilow)
median(coefP$ciup-coefP$cilow)

### If a taxon's confidence interval is off the charts (wider than than the distribution of all other taxa), we want to remove it, as it is both extremely low confidence and ruins the viualization
#coefP<- coefP[!(coefP$cilow==min(coefP$cilow)&coefP$ciup==max(coefP$ciup)),]

coefP<- coefP[coefP$ciup-coefP$cilow<10*median(coefP$ciup-coefP$cilow),]
                 
### Now, we might have some other outliers, with 

coefP<- arrange(coefP, desc(percentwet_11month)) ## arrange the coefficient object in descending order of the coefficient

## Now, the Burkholderia-Caballeronia-Paraburkholderia should be abbreviated as "BCP_group" for space
rownames(coefP)[rownames(coefP)=="Burkholderia-Caballeronia-Paraburkholderia"]<-"BCP_group"
coefP[coefP$taxID=="Burkholderia-Caballeronia-Paraburkholderia","taxID"] <- "BCP_group"

ggllvm_16SLleg<- ggplot(coefP, aes(x = percentwet_11month, y = reorder(taxID,percentwet_11month), fill = error_bar_color))+ 
  geom_point(shape=21, size=3.5)+
  geom_vline(xintercept = 0, lty = 2)+
  geom_errorbarh(aes(xmin = cilow, xmax = ciup, color = error_bar_color), size=0.8)+
  scale_color_manual(values = c("Positive" = "blue", "Negative" = "#E69F00", "Neutral" = "grey50"))+
  scale_fill_manual(values = c("Positive" = "blue", "Negative" = "#E69F00", "Neutral" = "grey50"))+
    theme(axis.text.y.left = element_text(size = 10, color = "black"),
        strip.text = element_text(size = 8, color = "black"),
        axis.text.x.bottom = element_text(size = 8),
        #axis.text.x.top = element_text(angle=35,vjust=1, hjust=1),
        plot.title=element_text(size=16, face = "bold", hjust = 0.8),
        axis.text.x = element_text(size = 8),
        #axis.text.y = element_text(size = 8),
        axis.title.y = element_blank(),
        legend.title = element_text(size = 16),
        legend.text = element_text(size = 16),
        legend.position = "bottom",
        plot.margin = unit(c(1.5, 0.3, 0, 0.3), "lines"))+
  labs(x="11-month percent wet covariate coefficient", color="Correlation coefficient with 11-month water persistence:", fill="Correlation coefficient with 11-month water persistence:", title = "Prokaryotes in leaf litter (n=40)")
ggllvm_16SLleg

ggllvm_16SL<- ggplot(coefP, aes(x = percentwet_11month, y = reorder(taxID,percentwet_11month), fill = error_bar_color))+ 
  geom_point(shape=21, size=3.5)+
  geom_vline(xintercept = 0, lty = 2)+
  geom_errorbarh(aes(xmin = cilow, xmax = ciup, color = error_bar_color), size=0.8)+
  scale_color_manual(values = c("Positive" = "blue", "Negative" = "#E69F00", "Neutral" = "grey50"))+
  scale_fill_manual(values = c("Positive" = "blue", "Negative" = "#E69F00", "Neutral" = "grey50"))+
    theme(axis.text.y.left = element_text(size = 10, color = "black"),
        strip.text = element_text(size = 8, color = "black"),
        axis.text.x.bottom = element_text(size = 8),
        #axis.text.x.top = element_text(angle=35,vjust=1, hjust=1),
        plot.title=element_text(size=16, face = "bold", hjust = 0.8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8),
        axis.title.y = element_blank(),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 7),
        legend.position = "none",
        plot.margin = unit(c(1.5, 0.3, 0, 0.3), "lines"))+
  labs(x="11-month percent wet covariate coefficient", color="Effect:", fill="Effect:", title = "Prokaryotes in leaf litter (n=40)")
ggllvm_16SL

```



#### Epilithon Species at sites with stic data
```{r}
library(stringr)
genmerge_B<- genus_merge[genus_merge$substrate=='B',]
genmerge_B<- genmerge_B[!is.na(genmerge_B$percentwet_11month),]
gentemp_B<- genmerge_B[,1:gn]

#Reorder data table from most abundant to least abundant
gentemp_B <- gentemp_B[,order(colSums(-gentemp_B,na.rm=TRUE))]
gentemp_B <- gentemp_B[,apply(gentemp_B,2,function(x) sum(x > 0))>1]


genmerge_B <- merge(gentemp_B, samdf_16S,
                  by="row.names", all=FALSE)
rownames(genmerge_B) <- genmerge_B[,1]
genmerge_B <- genmerge_B[,-1]
genmerge_B<- genmerge_B[,colnames(genmerge_B)!="Unclassified_genus"]

B_abun<-genmerge_B[,1:40]
X <- as.matrix(genmerge_B[,c("percentwet_11month","LL_AFDM_prc")])
y<-as.matrix(as.tibble(B_abun))

gllvm(y, family = "poisson")
gllvm(y, family = "negative.binomial")
fit_ord<- gllvm(y, family = "negative.binomial")
ordiplot(fit_ord, biplot=TRUE, ind.gen=14)

#gllvm(y, X, family = "negative.binomial")
#gllvm(y, family = "negative.binomial")
#gllvm(formula = y~X$prc_wet, family = "negative.binomial")

fit_env <- gllvm(y, X, family = "negative.binomial", num.lv = 1,
                 formula = ~ percentwet_11month, seed = 2025)
coefplot(fit_env, cex.ylab = 0.7, mar = c(4, 9, 2, 1), mfrow=c(1,1))

pdf("GLLVM_16S_BB_plot.pdf", 
    )
gllvm16S_B<- coefplot(fit_env, cex.ylab = 0.7, mar = c(4, 15, 2, 1), mfrow=c(1,1))
gllvm16S_B
dev.off()
```

```{r}

coefP<- as.data.frame(fit_env$params$Xcoef) ## extract coefficients from gllvm
confP<- as.data.frame(confint(fit_env, parm = "Xcoef")) ##extract confidence intervals of coefficients from gllvm
row.names(confP)<- row.names(coefP) ## keeping consistent row names and order between coefficient and confidence interval objects
coefP<- merge(coefP, confP[,1:2], by="row.names", all = TRUE) ## merging coefficient and confidence interval objects
row.names(coefP)<- coefP[,1] ## converts the actual row names of the new merged object to the unfortunate "Row.names" column created after merging
coefP<- coefP[,-1] ## remove the unfortunate "Row.names" column from the object
coefP<- coefP %>% 
  mutate(taxID = row.names(coefP))   ## create a column with the species ID from the row names
coefP<- coefP %>%             ## create a color key for the confidence intervals
  mutate(error_bar_color = case_when(
    cilow > 0 ~ "Positive",
    ciup < 0 ~ "Negative",
    TRUE ~ "Neutral"
  ))

### checking for outliers
coefP$ciup-coefP$cilow
mean(coefP$percentwet_11month)
sd(coefP$percentwet_11month)
mean(coefP$ciup-coefP$cilow)
sd(coefP$ciup-coefP$cilow)

### If a taxon's confidence interval is off the charts (wider than than the distribution of all other taxa), we want to remove it, as it is both extremely low confidence and ruins the viualization
coefP<- coefP[coefP$ciup-coefP$cilow<10*median(coefP$ciup-coefP$cilow),]

coefP<- arrange(coefP, desc(percentwet_11month)) ## arrange the coefficient object in descending order of the coefficient

## Now, the Burkholderia-Caballeronia-Paraburkholderia should be abbreviated as "BCP_group" for space
rownames(coefP)[rownames(coefP)=="Burkholderia-Caballeronia-Paraburkholderia"]<-"BCP_group"
coefP[coefP$taxID=="Burkholderia-Caballeronia-Paraburkholderia","taxID"] <- "BCP_group"

ggllvm_16SB<- ggplot(coefP, aes(x = percentwet_11month, y = reorder(taxID,percentwet_11month), fill = error_bar_color))+ 
  geom_point(shape=21, size=3.5)+
  geom_vline(xintercept = 0, lty = 2)+
  geom_errorbarh(aes(xmin = cilow, xmax = ciup, color = error_bar_color), size=0.8)+
  scale_color_manual(values = c("Positive" = "blue", "Negative" = "#E69F00", "Neutral" = "grey50"))+
  scale_fill_manual(values = c("Positive" = "blue", "Negative" = "#E69F00", "Neutral" = "grey50"))+
    theme(axis.text.y.left = element_text(size = 10, color = "black"),
        strip.text = element_text(size = 8, color = "black"),
        axis.text.x.bottom = element_text(size = 8),
        #axis.text.x.top = element_text(angle=40,vjust=1, hjust=1),
        plot.title=element_text(size=16, face = "bold", hjust = 0.8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8),
        axis.title.y = element_blank(),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 7),
        legend.position = "none",
        plot.margin = unit(c(1.5, 0.3, 0, 0.3), "lines"))+
  labs(x="11-month percent wet covariate coefficient", color="Effect:", fill="Effect:", title = "Prokaryotes in epilithon (n=35)")
ggllvm_16SB
#56B4E9
```



#### Sediment Species at sites with stic data
```{r}
library(stringr)
genmerge_S<- genus_merge[genus_merge$substrate=='S',]
genmerge_S<- genmerge_S[!is.na(genmerge_S$percentwet_11month),]
gentemp_S<- genmerge_S[,1:gn]

#Reorder data table from most abundant to least abundant
gentemp_S <- gentemp_S[,order(colSums(-gentemp_S,na.rm=TRUE))]
gentemp_S <- gentemp_S[,apply(gentemp_S,2,function(x) sum(x > 0))>1]


genmerge_S <- merge(gentemp_S, samdf_16S,
                  by="row.names", all=FALSE)
rownames(genmerge_S) <- genmerge_S[,1]
genmerge_S <- genmerge_S[,-1]
genmerge_S<- genmerge_S[,colnames(genmerge_S)!="Unclassified_genus"]

S_abun<-genmerge_S[,1:40]
X <- as.matrix(genmerge_S[,c("percentwet_11month","LL_AFDM_prc")])
y<-as.matrix(as.tibble(S_abun))

gllvm(y, family = "poisson")
gllvm(y, family = "negative.binomial")
fit_ord<- gllvm(y, family = "negative.binomial")
ordiplot(fit_ord, biplot=TRUE, ind.gen=14)

#gllvm(y, X, family = "negative.binomial")
#gllvm(y, family = "negative.binomial")
#gllvm(formula = y~X$prc_wet, family = "negative.binomial")

fit_env <- gllvm(y, X, family = "negative.binomial", num.lv = 1,
                 formula = ~ percentwet_11month, seed = 2025)
coefplot(fit_env, cex.ylab = 0.7, mar = c(4, 9, 2, 1), mfrow=c(1,1))

pdf("GLLVM_16S_SS_plot.pdf", 
    )
gllvm16S_S<- coefplot(fit_env, cex.ylab = 0.7, mar = c(4, 15, 2, 1), mfrow=c(1,1))
gllvm16S_S
dev.off()
```

```{r}

coefP<- as.data.frame(fit_env$params$Xcoef) ## extract coefficients from gllvm
confP<- as.data.frame(confint(fit_env, parm = "Xcoef")) ##extract confidence intervals of coefficients from gllvm
row.names(confP)<- row.names(coefP) ## keeping consistent row names and order between coefficient and confidence interval objects
coefP<- merge(coefP, confP[,1:2], by="row.names", all = TRUE) ## merging coefficient and confidence interval objects
row.names(coefP)<- coefP[,1] ## converts the actual row names of the new merged object to the unfortunate "Row.names" column created after merging
coefP<- coefP[,-1] ## remove the unfortunate "Row.names" column from the object
coefP<- coefP %>% 
  mutate(taxID = row.names(coefP))   ## create a column with the species ID from the row names
coefP<- coefP %>%             ## create a color key for the confidence intervals
  mutate(error_bar_color = case_when(
    cilow > 0 ~ "Positive",
    ciup < 0 ~ "Negative",
    TRUE ~ "Neutral"
  ))

### checking for outliers
coefP$ciup-coefP$cilow
mean(coefP$percentwet_11month)
sd(coefP$percentwet_11month)
mean(coefP$ciup-coefP$cilow)
sd(coefP$ciup-coefP$cilow)

### If a taxon's confidence interval is off the charts (wider than than the distribution of all other taxa), we want to remove it, as it is both extremely low confidence and ruins the viualization
coefP<- coefP[coefP$ciup-coefP$cilow<10*median(coefP$ciup-coefP$cilow),]

coefP<- arrange(coefP, desc(percentwet_11month)) ## arrange the coefficient object in descending order of the coefficient

## Now, the Burkholderia-Caballeronia-Paraburkholderia should be abbreviated as "BCP_group" for space
rownames(coefP)[rownames(coefP)=="Burkholderia-Caballeronia-Paraburkholderia"]<-"BCP_group"
coefP[coefP$taxID=="Burkholderia-Caballeronia-Paraburkholderia","taxID"] <- "BCP_group"

ggllvm_16SS<- ggplot(coefP, aes(x = percentwet_11month, y = reorder(taxID,percentwet_11month), fill = error_bar_color))+ 
  geom_point(shape=21, size=3.5)+
  geom_vline(xintercept = 0, lty = 2)+
  geom_errorbarh(aes(xmin = cilow, xmax = ciup, color = error_bar_color), size=0.8)+
  scale_color_manual(values = c("Positive" = "blue", "Negative" = "#E69F00", "Neutral" = "grey50"))+
  scale_fill_manual(values = c("Positive" = "blue", "Negative" = "#E69F00", "Neutral" = "grey50"))+
    theme(axis.text.y.left = element_text(size = 10, color = "black"),
        strip.text = element_text(size = 8, color = "black"),
        axis.text.x.bottom = element_text(size = 8),
        #axis.text.x.top = element_text(angle=40,vjust=1, hjust=1),
        plot.title=element_text(size=16, face = "bold", hjust = 0.8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8),
        axis.title.y = element_blank(),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 7),
        legend.position = "none",
        plot.margin = unit(c(1.5, 0.3, 0, 0.3), "lines"))+
  labs(x="11-month percent wet covariate coefficient", color="Effect:", fill="Effect:", title = "Prokaryotes in sediment (n=40)")
ggllvm_16SS

```


###############################################
# Top Fungal ASVs/spp

In the past I've lumped taxa to the gens level for corrplots, but I see some aquatic hyphomycete species standing out that I'd like to keep at the species level. So, I will make a new object combining
```{r}
pseqtestITS_spp <- pseqtestITS
### If Species == NA, rename 'spp.'. We will merge these, so potentially multiple species may be merged together.
na.sp = !is.na(tax_table(pseqtestITS_spp)[,"Genus"]) & is.na(tax_table(pseqtestITS_spp)[,"Species"])
tax_table(pseqtestITS_spp)[na.sp][,"Species"] <- "spp. unid."
na.gn  = is.na(tax_table(pseqtestITS_spp)[,"Genus"])
tax_table(pseqtestITS_spp)[na.gn][,"Species"] <- ""
### good

### Now, make "Species" "Genus species"
## Genus and Species is not NA
no.na <- !is.na(tax_table(pseqtestITS_spp)[,"Genus"]) & !is.na(tax_table(pseqtestITS_spp)[,"Species"])
## Replace Species with full name
tax_table(pseqtestITS_spp)[no.na][,"Species"] <- paste(tax_table(pseqtestITS_spp)[no.na][,"Genus"], tax_table(pseqtestITS_spp)[no.na][,"Species"])

## We could also include unidentified families or higher levels
### family
#lo.fam<- !is.na(tax_table(pseqtestITS_spp)[,"Family"]) & is.na(tax_table(pseqtestITS_spp)[,"Genus"])
#tax_table(pseqtestITS_spp)[lo.fam][,"Species"] <- paste("unidentified", tax_table(pseqtestITS_spp)[lo.fam][,"Family"])

```

Now we will agglomerate ('lump') taxa to the lowest rank possible.
```{r}
### species agglomeration
## make taxonomy object by species
spp_counts_tab <- otu_table(tax_glom(pseqtestITS_spp, taxrank = "Species"), taxa_are_rows = FALSE)
spp_counts_tab <- t(spp_counts_tab)
## make vector of species names to set as row names
spp_tax_vec <- as.vector(tax_table(tax_glom(pseqtestITS_spp, taxrank="Species"))[,7]) 
rownames(spp_counts_tab) <- as.vector(spp_tax_vec)

asv_counts <- pseqtestITS_spp@otu_table
#determine the number of unclassified seqs at the species level
unclassified_spp_counts <- colSums(t(asv_counts)) - colSums(spp_counts_tab)
#Add a row of "unclassified" to the species count table
species_and_unidentified_counts_tab <- rbind(spp_counts_tab, "Unclassified_species"=unclassified_spp_counts)

## test all counts are accounted for
identical(colSums(species_and_unidentified_counts_tab), rowSums(asv_counts))

## convert counts to percent abundance:
species_proportions <- apply(species_and_unidentified_counts_tab, 2, function(x) x/sum(x)*100)

species_proportions<- species_proportions[!grepl("Incertae",rownames(species_proportions)),]

#Merge with metadata
species_merge <- merge(t(species_proportions), samdf_ITS,
                  by="row.names", all=TRUE)
rownames(species_merge) <- species_merge[,1]
species_merge <- species_merge[,-1]

## remove genera Incertae sedis
#species_merge<- species_merge[,!grepl("Incertae",colnames(species_merge))]

gn<- as.numeric(nrow(species_merge))
```

#### Leaf Litter Species at sites with stic data
```{r}
library(stringr)
sppmerge_L<- species_merge[species_merge$substrate=='L',]
sppmerge_L<- sppmerge_L[!is.na(sppmerge_L$percentwet_11month),]
spptemp_L<- sppmerge_L[,1:gn]

#Reorder data table from most abundant to least abundant
spptemp_L <- spptemp_L[,order(colSums(-spptemp_L,na.rm=TRUE))]
spptemp_L <- spptemp_L[,apply(spptemp_L,2,function(x) sum(x > 0))>1]


sppmerge_L <- merge(spptemp_L, samdf_ITS,
                  by="row.names", all=FALSE)
rownames(sppmerge_L) <- sppmerge_L[,1]
sppmerge_L <- sppmerge_L[,-1]
sppmerge_L<- sppmerge_L[,colnames(sppmerge_L)!="Unclassified_species"]
```

gglvm of top leaf taxa
```{r}
library(mvabund)
library(gllvm)
library(tidyverse)

#detach("package:linkET", unload=TRUE)
L_abun<-sppmerge_L[,1:40]
X <- as.matrix(sppmerge_L[,c("percentwet_11month","LL_AFDM_prc")])
y<-as.matrix(as.tibble(L_abun))

gllvm(y, family = "poisson")
gllvm(y, family = "negative.binomial")
fit_ord<- gllvm(y, family = "negative.binomial")
ordiplot(fit_ord, biplot=TRUE, ind.spp=14)

#gllvm(y, X, family = "negative.binomial")
#gllvm(y, family = "negative.binomial")
#gllvm(formula = y~X$prc_wet, family = "negative.binomial")

fit_env <- gllvm(y, X, family = "negative.binomial", num.lv = 1,
                 formula = ~ percentwet_11month, seed = 2025)
coefplot(fit_env, cex.ylab = 0.7, mar = c(4, 9, 2, 1), mfrow=c(1,1))

pdf("GLLVM_ITS_LL_plot.pdf", 
    )
gllvmITS_L<- coefplot(fit_env, cex.ylab = 0.7, mar = c(4, 15, 2, 1), mfrow=c(1,1))
gllvmITS_L
dev.off()
```

```{r}

coefP<- as.data.frame(fit_env$params$Xcoef) ## extract coefficients from gllvm
confP<- as.data.frame(confint(fit_env, parm = "Xcoef")) ##extract confidence intervals of coefficients from gllvm
row.names(confP)<- row.names(coefP) ## keeping consistent row names and order between coefficient and confidence interval objects
coefP<- merge(coefP, confP[,1:2], by="row.names", all = TRUE) ## merging coefficient and confidence interval objects
row.names(coefP)<- coefP[,1] ## converts the actual row names of the new merged object to the unfortunate "Row.names" column created after merging
coefP<- coefP[,-1] ## remove the unfortunate "Row.names" column from the object
coefP<- coefP %>% 
  mutate(taxID = row.names(coefP))   ## create a column with the species ID from the row names
coefP<- coefP %>%             ## create a color key for the confidence intervals
  mutate(error_bar_color = case_when(
    cilow > 0 ~ "Positive",
    ciup < 0 ~ "Negative",
    TRUE ~ "Neutral"
  ))

### checking for outliers
coefP$ciup-coefP$cilow
mean(coefP$percentwet_11month)
sd(coefP$percentwet_11month)
mean(coefP$ciup-coefP$cilow)
sd(coefP$ciup-coefP$cilow)

### If a taxon's confidence interval is off the charts (wider than than the distribution of all other taxa), we want to remove it, as it is both extremely low confidence and ruins the viualization
coefP<- coefP[coefP$ciup-coefP$cilow<10*median(coefP$ciup-coefP$cilow),]

coefP<- arrange(coefP, desc(percentwet_11month)) ## arrange the coefficient object in descending order of the coefficient

## Now, the Burkholderia-Caballeronia-Paraburkholderia should be abbreviated as "BCP_group" for space
#rownames(coefP)[rownames(coefP)=="Burkholderia-Caballeronia-Paraburkholderia"]<-"BCP_group"
#coefP[coefP$taxID=="Tremellodendropsidales_gen_Incertae_sedis spp. unid.","taxID"] <- "Tremellodendropsidales gen. In. sed"

ggllvm_ITSL<- ggplot(coefP, aes(x = percentwet_11month, y = reorder(taxID,percentwet_11month), fill = error_bar_color))+ 
  geom_point(shape=21, size=3.5)+
  geom_vline(xintercept = 0, lty = 2)+
  geom_errorbarh(aes(xmin = cilow, xmax = ciup, color = error_bar_color), size=0.8)+
  scale_color_manual(values = c("Positive" = "blue", "Negative" = "#E69F00", "Neutral" = "grey50"))+
  scale_fill_manual(values = c("Positive" = "blue", "Negative" = "#E69F00", "Neutral" = "grey50"))+
    theme(axis.text.y.left = element_text(size = 10, color = "black"),
        strip.text = element_text(size = 8, color = "black"),
        axis.text.x.bottom = element_text(size = 8),
        #axis.text.x.top = element_text(angle=40,vjust=1, hjust=1),
        plot.title=element_text(size=16, face = "bold", hjust = 0.8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8),
        axis.title.y = element_blank(),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 7),
        legend.position = "none",
        plot.margin = unit(c(1.5, 0.3, 0, 0.3), "lines"))+
  labs(x="11-month percent wet covariate coefficient", color="Effect:", fill="Effect:", title = "Fungi in leaf litter (n=40)")
ggllvm_ITSL
#56B4E9
```

#### Epilithon Species at sites with stic data
```{r}
library(stringr)
sppmerge_B<- species_merge[species_merge$substrate=='B',]
sppmerge_B<- sppmerge_B[!is.na(sppmerge_B$percentwet_11month),]
spptemp_B<- sppmerge_B[,1:gn]

#Reorder data table from most abundant to least abundant
spptemp_B <- spptemp_B[,order(colSums(-spptemp_B,na.rm=TRUE))]
spptemp_B <- spptemp_B[,apply(spptemp_B,2,function(x) sum(x > 0))>1]


sppmerge_B <- merge(spptemp_B, samdf_ITS,
                  by="row.names", all=FALSE)
rownames(sppmerge_B) <- sppmerge_B[,1]
sppmerge_B <- sppmerge_B[,-1]
sppmerge_B<- sppmerge_B[,colnames(sppmerge_B)!="Unclassified_species"]
```

gglvm of top leaf taxa
```{r}
library(mvabund)
library(gllvm)
library(tidyverse)

#detach("package:linkET", unload=TRUE)
B_abun<-sppmerge_B[,1:40]
colSums(B_abun)

X <- as.matrix(sppmerge_B[,c("percentwet_11month","LL_AFDM_prc")])
y<-as.matrix(as.tibble(B_abun))

gllvm(y, family = "poisson")
gllvm(y, family = "negative.binomial")
fit_ord<- gllvm(y, family = "negative.binomial")
ordiplot(fit_ord, biplot=TRUE, ind.spp=14)

#gllvm(y, X, family = "negative.binomial")
#gllvm(y, family = "negative.binomial")
#gllvm(formula = y~X$prc_wet, family = "negative.binomial")

fit_env <- gllvm(y, X, family = "negative.binomial", num.lv = 1,
                 formula = ~ percentwet_11month, seed = 2025)
coefplot(fit_env, cex.ylab = 0.7, mar = c(4, 9, 2, 1), mfrow=c(1,1))

pdf("GLLVM_ITS_BB_plot.pdf", 
    )
gllvmITS_B<- coefplot(fit_env, cex.ylab = 0.7, mar = c(4, 15, 2, 1), mfrow=c(1,1))
gllvmITS_B
dev.off()
```

```{r}

coefP<- as.data.frame(fit_env$params$Xcoef) ## extract coefficients from gllvm
confP<- as.data.frame(confint(fit_env, parm = "Xcoef")) ##extract confidence intervals of coefficients from gllvm
row.names(confP)<- row.names(coefP) ## keeping consistent row names and order between coefficient and confidence interval objects
coefP<- merge(coefP, confP[,1:2], by="row.names", all = TRUE) ## merging coefficient and confidence interval objects
row.names(coefP)<- coefP[,1] ## converts the actual row names of the new merged object to the unfortunate "Row.names" column created after merging
coefP<- coefP[,-1] ## remove the unfortunate "Row.names" column from the object
coefP<- coefP %>% 
  mutate(taxID = row.names(coefP))   ## create a column with the species ID from the row names
coefP<- coefP %>%             ## create a color key for the confidence intervals
  mutate(error_bar_color = case_when(
    cilow > 0 ~ "Positive",
    ciup < 0 ~ "Negative",
    TRUE ~ "Neutral"
  ))

### checking for outliers
coefP$ciup-coefP$cilow
mean(coefP$percentwet_11month)
sd(coefP$percentwet_11month)
mean(coefP$ciup-coefP$cilow)
sd(coefP$ciup-coefP$cilow)

### If a taxon's confidence interval is off the charts (wider than than the distribution of all other taxa), we want to remove it, as it is both extremely low confidence and ruins the viualization
#coefP<- coefP[!(coefP$cilow==min(coefP$cilow)&coefP$ciup==max(coefP$ciup)),] 
coefP<- coefP[coefP$ciup-coefP$cilow<10*median(coefP$ciup-coefP$cilow),]

coefP<- arrange(coefP, desc(percentwet_11month)) ## arrange the coefficient object in descending order of the coefficient

## Now, the Burkholderia-Caballeronia-Paraburkholderia should be abbreviated as "BCP_group" for space
#rownames(coefP)[rownames(coefP)=="Burkholderia-Caballeronia-Paraburkholderia"]<-"BCP_group"
#coefP[coefP$taxID=="Pleosporaceae_gen_Incertae_sedis spp. unid.","taxID"] <- "Pleosporaceae gen. In. sed."
#coefP[coefP$taxID=="Pannariaceae_gen_Incertae_sedis spp. unid.","taxID"] <- "Pannariaceae gen. In. sed."
#coefP[coefP$taxID=="Capnodiales_gen_Incertae_sedis spp. unid.","taxID"] <- "Capnodiales gen. In. sed."
#coefP[coefP$taxID=="Pleosporaceae_gen_Incertae_sedis spp. unid.","taxID"] <- "Pleosporaceae gen. In. sed."

ggllvm_ITSB<- ggplot(coefP, aes(x = percentwet_11month, y = reorder(taxID,percentwet_11month), fill = error_bar_color))+ 
  geom_point(shape=21, size=3.5)+
  geom_vline(xintercept = 0, lty = 2)+
  geom_errorbarh(aes(xmin = cilow, xmax = ciup, color = error_bar_color), size=0.8)+
  scale_color_manual(values = c("Positive" = "blue", "Negative" = "#E69F00", "Neutral" = "grey50"))+
  scale_fill_manual(values = c("Positive" = "blue", "Negative" = "#E69F00", "Neutral" = "grey50"))+
    theme(axis.text.y.left = element_text(size = 10, color = "black"),
        strip.text = element_text(size = 8, color = "black"),
        axis.text.x.bottom = element_text(size = 8),
        #axis.text.x.top = element_text(angle=40,vjust=1, hjust=1),
        plot.title=element_text(size=16, face = "bold", hjust = 0.8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8),
        axis.title.y = element_blank(),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 7),
        legend.position = "none",
        plot.margin = unit(c(1.5, 0.3, 0, 0.3), "lines"))+
  labs(x="11-month percent wet covariate coefficient", color="Effect:", fill="Effect:", title = "Fungi in epilithon (n=26)")
ggllvm_ITSB
#56B4E9
```


#### Sediment Species at sites with stic data
```{r}
library(stringr)
sppmerge_S<- species_merge[species_merge$substrate=='S',]
sppmerge_S<- sppmerge_S[!is.na(sppmerge_S$percentwet_11month),]
spptemp_S<- sppmerge_S[,1:gn]

#Reorder data table from most abundant to least abundant
spptemp_S <- spptemp_S[,order(colSums(-spptemp_S,na.rm=TRUE))]
spptemp_S <- spptemp_S[,apply(spptemp_S,2,function(x) sum(x > 0))>1]


sppmerge_S <- merge(spptemp_S, samdf_ITS,
                  by="row.names", all=FALSE)
rownames(sppmerge_S) <- sppmerge_S[,1]
sppmerge_S <- sppmerge_S[,-1]
sppmerge_S<- sppmerge_S[,colnames(sppmerge_S)!="Unclassified_species"]
```

```{r}
library(mvabund)
library(gllvm)
library(tidyverse)

#detach("package:linkET", unload=TRUE)
S_abun<-sppmerge_S[,1:40]
colSums(S_abun)

X <- as.matrix(sppmerge_S[,c("percentwet_11month","LL_AFDM_prc")])
y<-as.matrix(as.tibble(S_abun))

gllvm(y, family = "poisson")
gllvm(y, family = "negative.binomial")
fit_ord<- gllvm(y, family = "negative.binomial")
ordiplot(fit_ord, biplot=TRUE, ind.spp=14)

#gllvm(y, X, family = "negative.binomial")
#gllvm(y, family = "negative.binomial")
#gllvm(formula = y~X$prc_wet, family = "negative.binomial")

fit_env <- gllvm(y, X, family = "negative.binomial", num.lv = 1,
                 formula = ~ percentwet_11month, seed = 2025)
coefplot(fit_env, cex.ylab = 0.7, mar = c(4, 9, 2, 1), mfrow=c(1,1))

pdf("GLLVM_ITS_SS_plot.pdf", 
    )
gllvmITS_S<- coefplot(fit_env, cex.ylab = 0.7, mar = c(4, 15, 2, 1), mfrow=c(1,1))
gllvmITS_S
dev.off()
```

```{r}

coefP<- as.data.frame(fit_env$params$Xcoef) ## extract coefficients from gllvm
confP<- as.data.frame(confint(fit_env, parm = "Xcoef")) ##extract confidence intervals of coefficients from gllvm
row.names(confP)<- row.names(coefP) ## keeping consistent row names and order between coefficient and confidence interval objects
coefP<- merge(coefP, confP[,1:2], by="row.names", all = TRUE) ## merging coefficient and confidence interval objects
row.names(coefP)<- coefP[,1] ## converts the actual row names of the new merged object to the unfortunate "Row.names" column created after merging
coefP<- coefP[,-1] ## remove the unfortunate "Row.names" column from the object
coefP<- coefP %>% 
  mutate(taxID = row.names(coefP))   ## create a column with the species ID from the row names
coefP<- coefP %>%             ## create a color key for the confidence intervals
  mutate(error_bar_color = case_when(
    cilow > 0 ~ "Positive",
    ciup < 0 ~ "Negative",
    TRUE ~ "Neutral"
  ))

### checking for outliers
coefP$ciup-coefP$cilow
mean(coefP$percentwet_11month)
sd(coefP$percentwet_11month)
mean(coefP$ciup-coefP$cilow)
sd(coefP$ciup-coefP$cilow)

### If a taxon's confidence interval is off the charts (wider than than the distribution of all other taxa), we want to remove it, as it is both extremely low confidence and ruins the viualization
#coefP<- coefP[!(coefP$cilow==min(coefP$cilow)&coefP$ciup==max(coefP$ciup)),] 
coefP<- coefP[coefP$ciup-coefP$cilow<10*median(coefP$ciup-coefP$cilow),]
coefP<- coefP[coefP$ciup<10*median(coefP$ciup),]

coefP<- arrange(coefP, desc(percentwet_11month)) ## arrange the coefficient object in descending order of the coefficient

## Now, the Burkholderia-Caballeronia-Paraburkholderia should be abbreviated as "BCP_group" for space
#rownames(coefP)[rownames(coefP)=="Burkholderia-Caballeronia-Paraburkholderia"]<-"BCP_group"
#coefP[coefP$taxID=="Burkholderia-Caballeronia-Paraburkholderia","taxID"] <- "BCP_group"

ggllvm_ITSS<- ggplot(coefP, aes(x = percentwet_11month, y = reorder(taxID,percentwet_11month), fill = error_bar_color))+ 
  geom_point(shape=21, size=3.5)+
  geom_vline(xintercept = 0, lty = 2)+
  geom_errorbarh(aes(xmin = cilow, xmax = ciup, color = error_bar_color), size=0.8)+
  scale_color_manual(values = c("Positive" = "blue", "Negative" = "#E69F00", "Neutral" = "grey50"))+
  scale_fill_manual(values = c("Positive" = "blue", "Negative" = "#E69F00", "Neutral" = "grey50"))+
    theme(axis.text.y.left = element_text(size = 10, color = "black"),
        axis.text.x.bottom = element_text(size = 8),
        #axis.text.x.top = element_text(angle=35,vjust=1, hjust=1),
        plot.title=element_text(size=16, face = "bold", hjust = 0.8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8),
        axis.title.y = element_blank(),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 7),
        legend.position = "none",
        plot.margin = unit(c(1.5, 0.3, 0, 0.3), "lines"))+
  labs(x="11-month percent wet covariate coefficient", color="Effect:", fill="Effect:", title = "Fungi in sediment (n=32)")
ggllvm_ITSS
#56B4E9
```

```{r}
library(cowplot)

six_gllvm<- plot_grid(ggllvm_16SL, ggllvm_16SB, ggllvm_16SS, ggllvm_ITSL, ggllvm_ITSB, ggllvm_ITSS, ncol=3, align="hv", labels="AUTO")#, labels=c, rel_widths = c(1, 1.618))
six_gllvm

leg <- get_legend(ggllvm_16SLleg)
leg
plotout <- "six_gllvm_08.28.2025.tiff"
agg_tiff(filename=plotout, width=4800, height=3800, units="px",
         pointsize=10, res=600, compression="lzw", scaling=0.5)
plot_grid(six_gllvm, leg, ncol=1, rel_heights = c(1,0.05))
invisible(dev.off())

```
